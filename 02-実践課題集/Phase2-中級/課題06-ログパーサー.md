# èª²é¡Œ06: ãƒ­ã‚°ãƒ‘ãƒ¼ã‚µãƒ¼

[[èª²é¡Œ05-æ±ç”¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ |â† å‰ã®èª²é¡Œ]]  |  [[README|ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹]]  |  [[èª²é¡Œ07-ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†|æ¬¡ã®èª²é¡Œ â†’]]

**é›£æ˜“åº¦:** â­ï¸â­ï¸â­ï¸
**å­¦ç¿’æ™‚é–“ç›®å®‰:** 5-7æ™‚é–“
**å­¦ç¿’ãƒˆãƒ”ãƒƒã‚¯:** ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã€ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã€æ­£è¦è¡¨ç¾ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

---

## ğŸ¯ èª²é¡Œã®ç›®çš„

ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã¨ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’ä½¿ã£ã¦ã€åŠ¹ç‡çš„ãªãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã¨é›†è¨ˆã‚’è¡Œã„ã¾ã™ã€‚

---

## ğŸ“‹ ä»•æ§˜

Webã‚µãƒ¼ãƒãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’è§£æã—ã€çµ±è¨ˆæƒ…å ±ã‚’å‡ºåŠ›ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

### ã‚µãƒ³ãƒ—ãƒ«ãƒ­ã‚° (access.log)

```log
192.168.1.1 - - [01/Jan/2024:10:00:01 +0000] "GET /index.html HTTP/1.1" 200 1234
192.168.1.2 - - [01/Jan/2024:10:00:05 +0000] "POST /api/users HTTP/1.1" 201 456
192.168.1.1 - - [01/Jan/2024:10:00:10 +0000] "GET /style.css HTTP/1.1" 200 789
192.168.1.3 - - [01/Jan/2024:10:00:15 +0000] "GET /notfound HTTP/1.1" 404 0
192.168.1.2 - - [01/Jan/2024:10:00:20 +0000] "GET /index.html HTTP/1.1" 200 1234
```

### å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½

```bash
# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰åˆ¥ã®é›†è¨ˆ
$ cargo run -- stats access.log
Status Code Statistics:
200: 3 requests
201: 1 request
404: 1 request

# IPã‚¢ãƒ‰ãƒ¬ã‚¹åˆ¥ã®ã‚¢ã‚¯ã‚»ã‚¹æ•°
$ cargo run -- ip access.log
IP Address Statistics:
192.168.1.1: 2 requests
192.168.1.2: 2 requests
192.168.1.3: 1 request

# ã‚¨ãƒ©ãƒ¼(4xx, 5xx)ã®ã¿è¡¨ç¤º
$ cargo run -- errors access.log
192.168.1.3 - 404 - GET /notfound
```

---

## ğŸ—ï¸ å®Ÿè£…ã‚¬ã‚¤ãƒ‰

### ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```rust
use regex::Regex;
use std::collections::HashMap;

#[derive(Debug)]
struct LogEntry {
    ip: String,
    timestamp: String,
    method: String,
    path: String,
    status: u16,
    size: usize,
}

impl LogEntry {
    fn parse(line: &str) -> Option<Self> {
        let re = Regex::new(
            r#"^(\S+) .* \[(.*?)\] "(\w+) (\S+) .*?" (\d+) (\d+)"#
        ).unwrap();

        re.captures(line).map(|caps| LogEntry {
            ip: caps[1].to_string(),
            timestamp: caps[2].to_string(),
            method: caps[3].to_string(),
            path: caps[4].to_string(),
            status: caps[5].parse().unwrap(),
            size: caps[6].parse().unwrap(),
        })
    }

    fn is_error(&self) -> bool {
        self.status >= 400
    }
}
```

### ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã¨ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®æ´»ç”¨

```rust
use std::fs::File;
use std::io::{BufRead, BufReader};

fn load_logs(filename: &str) -> Result<Vec<LogEntry>, std::io::Error> {
    let file = File::open(filename)?;
    let reader = BufReader::new(file);

    Ok(reader
        .lines()
        .filter_map(|line| line.ok())
        .filter_map(|line| LogEntry::parse(&line))
        .collect())
}

fn count_by_status(logs: &[LogEntry]) -> HashMap<u16, usize> {
    logs.iter()
        .map(|entry| entry.status)
        .fold(HashMap::new(), |mut map, status| {
            *map.entry(status).or_insert(0) += 1;
            map
        })
}

fn count_by_ip(logs: &[LogEntry]) -> HashMap<String, usize> {
    logs.iter()
        .map(|entry| entry.ip.clone())
        .fold(HashMap::new(), |mut map, ip| {
            *map.entry(ip).or_insert(0) += 1;
            map
        })
}

fn filter_errors(logs: &[LogEntry]) -> Vec<&LogEntry> {
    logs.iter()
        .filter(|entry| entry.is_error())
        .collect()
}
```

---

## ğŸ’¡ ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³

### map, filter, collect

```rust
// ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ãƒ‘ã‚¹ã ã‘ã‚’æŠ½å‡º
let error_paths: Vec<String> = logs.iter()
    .filter(|e| e.is_error())
    .map(|e| e.path.clone())
    .collect();

// 200ç•ªå°ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚µã‚¤ã‚ºã®åˆè¨ˆ
let total_size: usize = logs.iter()
    .filter(|e| e.status >= 200 && e.status < 300)
    .map(|e| e.size)
    .sum();
```

### foldï¼ˆç•³ã¿è¾¼ã¿ï¼‰

```rust
// Cè¨€èªã®ãƒ«ãƒ¼ãƒ—ã¨æ¯”è¼ƒ
// Cè¨€èª
int sum = 0;
for (int i = 0; i < len; i++) {
    sum += array[i];
}

// Rust
let sum: i32 = array.iter().fold(0, |acc, &x| acc + x);
// ã¾ãŸã¯
let sum: i32 = array.iter().sum();
```

---

## ğŸš€ ç™ºå±•èª²é¡Œ

### ãƒ¬ãƒ™ãƒ«1: æ™‚é–“å¸¯åˆ¥ã®é›†è¨ˆ

### ãƒ¬ãƒ™ãƒ«2: æœ€ã‚‚é…ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### ãƒ¬ãƒ™ãƒ«3: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ï¼ˆtail -f çš„ãªæ©Ÿèƒ½ï¼‰

---

## ğŸ”— é–¢é€£è³‡æ–™

- [The Rust Book: ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿](https://doc.rust-jp.rs/book-ja/ch13-02-iterators.html)
- [The Rust Book: ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£](https://doc.rust-jp.rs/book-ja/ch13-01-closures.html)

---

## ğŸ“ å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç†è§£ã—ãŸ
- [ ] ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®ä½¿ã„æ–¹ã‚’ç†è§£ã—ãŸ
- [ ] æ­£è¦è¡¨ç¾ã§ã®ãƒ‘ãƒ¼ã‚¹ãŒã§ãã‚‹
- [ ] ã™ã¹ã¦ã®åŸºæœ¬æ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹

---

[[èª²é¡Œ07-ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†|æ¬¡ã®èª²é¡Œ: ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç† â†’]]
